# å°ˆå“¡IDç®¡ç†ç³»çµ±æ•™å­¸æ–‡æª”

## ğŸ“‹ ç›®éŒ„

1. [ç³»çµ±æ¦‚è¿°](#ç³»çµ±æ¦‚è¿°)
2. [éœ€æ±‚åˆ†æ](#éœ€æ±‚åˆ†æ)
3. [æ¶æ§‹è¨­è¨ˆ](#æ¶æ§‹è¨­è¨ˆ)
4. [å¯¦ä½œç´°ç¯€](#å¯¦ä½œç´°ç¯€)
5. [ä»£ç¢¼è§£æ](#ä»£ç¢¼è§£æ)
6. [ä½¿ç”¨æ–¹å¼](#ä½¿ç”¨æ–¹å¼)
7. [æ¸¬è©¦æ–¹æ³•](#æ¸¬è©¦æ–¹æ³•)
8. [å¸¸è¦‹å•é¡Œ](#å¸¸è¦‹å•é¡Œ)

---

## ç³»çµ±æ¦‚è¿°

### ä»€éº¼æ˜¯å°ˆå“¡IDç®¡ç†ç³»çµ±ï¼Ÿ

å°ˆå“¡IDç®¡ç†ç³»çµ±æ˜¯ä¸€å€‹ç”¨æ–¼ç®¡ç†å°ˆå“¡Aå’Œå°ˆå“¡Bå”¯ä¸€è­˜åˆ¥ç¢¼çš„ç³»çµ±ã€‚å®ƒè§£æ±ºäº†ä»¥ä¸‹å•é¡Œï¼š

1. **å›ºå®šIDç®¡ç†**ï¼šç¢ºä¿å°ˆå“¡Aå’Œå°ˆå“¡Bå„è‡ªæœ‰å›ºå®šçš„IDï¼Œè€Œä¸æ˜¯æ¯æ¬¡é€£æ¥éƒ½ç”Ÿæˆæ–°çš„éš¨æ©ŸID
2. **é˜²æ­¢å¤šé‡é€£æ¥**ï¼šé˜²æ­¢åŒä¸€å€‹å°ˆå“¡é–‹å¤šå€‹ç¶²é éƒ½é¡¯ç¤ºé€£ç·šï¼Œç¢ºä¿åªæœ‰æœ€æ–°çš„é€£æ¥æœ‰æ•ˆ
3. **è‡ªå‹•åŒ–æµç¨‹**ï¼šå‰ç«¯è‡ªå‹•å¾APIç²å–å°ˆå“¡IDï¼Œç„¡éœ€æ‰‹å‹•è¼¸å…¥
4. **åŸå­æ€§æ“ä½œ**ï¼šä½¿ç”¨Luaè…³æœ¬ç¢ºä¿Redisæ“ä½œçš„åŸå­æ€§ï¼Œé¿å…ä½µç™¼å•é¡Œ

### ç³»çµ±ç‰¹é»

- âœ… **å›ºå®šID**ï¼šå°ˆå“¡Aå’Œå°ˆå“¡Bå„è‡ªæœ‰å”¯ä¸€çš„å›ºå®šID
- âœ… **è‡ªå‹•ç²å–**ï¼šå‰ç«¯è‡ªå‹•å¾APIç²å–å°ˆå“¡ID
- âœ… **åŸå­æ€§ä¿è­‰**ï¼šä½¿ç”¨Luaè…³æœ¬ç¢ºä¿æ“ä½œçš„åŸå­æ€§
- âœ… **è‡ªå‹•è¦†è“‹**ï¼šå¦‚æœIDæ”¹è®Šï¼Œæœƒè‡ªå‹•è¦†è“‹èˆŠçš„IDï¼ˆå£“æ‰ï¼‰
- âœ… **å³æ™‚æ›´æ–°**ï¼šå‰ç«¯æ¯5ç§’è‡ªå‹•æ›´æ–°å°ˆå“¡ID

---

## éœ€æ±‚åˆ†æ

### åŸå§‹å•é¡Œ

åœ¨å¯¦ä½œå°ˆå“¡IDç®¡ç†ç³»çµ±ä¹‹å‰ï¼Œç³»çµ±å­˜åœ¨ä»¥ä¸‹å•é¡Œï¼š

1. **éš¨æ©ŸIDå•é¡Œ**ï¼š
   - æ¯æ¬¡WebSocketé€£æ¥éƒ½æœƒç”Ÿæˆæ–°çš„éš¨æ©ŸUUID
   - å°ˆå“¡Aå’Œå°ˆå“¡Bçš„IDä¸å›ºå®šï¼Œç„¡æ³•ç©©å®šè­˜åˆ¥
   - ç§ä¿¡åŠŸèƒ½éœ€è¦æ‰‹å‹•è¼¸å…¥ç›®æ¨™å°ˆå“¡çš„ID

2. **å¤šé‡é€£æ¥å•é¡Œ**ï¼š
   - åŒä¸€å€‹å°ˆå“¡å¯ä»¥é–‹å¤šå€‹ç¶²é ï¼Œæ¯å€‹ç¶²é éƒ½é¡¯ç¤ºã€Œå·²é€£æ¥ã€
   - ç„¡æ³•åˆ¤æ–·å“ªå€‹é€£æ¥æ˜¯æœ‰æ•ˆçš„
   - è¨Šæ¯å¯èƒ½ç™¼é€åˆ°éŒ¯èª¤çš„é€£æ¥

3. **ç”¨æˆ¶é«”é©—å•é¡Œ**ï¼š
   - éœ€è¦æ‰‹å‹•è¼¸å…¥å°ˆå“¡ID
   - éœ€è¦å¾localStorageè¼‰å…¥ID
   - æ“ä½œç¹ç‘£ï¼Œå®¹æ˜“å‡ºéŒ¯

### è§£æ±ºæ–¹æ¡ˆ

1. **å›ºå®šIDå­˜å„²**ï¼š
   - å°ˆå“¡Aå’Œå°ˆå“¡Bçš„IDå­˜å„²åœ¨Redisä¸­
   - ä½¿ç”¨å›ºå®šçš„Redis keyï¼š`agent:a:id` å’Œ `agent:b:id`

2. **è‡ªå‹•ç²å–æ©Ÿåˆ¶**ï¼š
   - å‰ç«¯é é¢è¼‰å…¥æ™‚è‡ªå‹•èª¿ç”¨APIç²å–å°ˆå“¡ID
   - å®šæœŸæ›´æ–°å°ˆå“¡IDï¼ˆæ¯5ç§’ï¼‰

3. **åŸå­æ€§æ“ä½œ**ï¼š
   - ä½¿ç”¨Luaè…³æœ¬ç¢ºä¿Redisæ“ä½œçš„åŸå­æ€§
   - å¦‚æœIDæ”¹è®Šï¼Œè‡ªå‹•è¦†è“‹èˆŠçš„ID

4. **é€£æ¥ç®¡ç†**ï¼š
   - WebSocketæ¡æ‰‹æ™‚æ ¹æ“šè«‹æ±‚è·¯å¾‘åˆ¤æ–·å°ˆå“¡é¡å‹
   - å¾Redisç²å–æˆ–å‰µå»ºå°æ‡‰çš„å°ˆå“¡ID

---

## æ¶æ§‹è¨­è¨ˆ

### ç³»çµ±æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ (Browser)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  agent-a.html â”‚              â”‚  agent-b.html â”‚            â”‚
â”‚  â”‚               â”‚              â”‚               â”‚            â”‚
â”‚  â”‚ 1. è¼‰å…¥é é¢    â”‚              â”‚ 1. è¼‰å…¥é é¢    â”‚            â”‚
â”‚  â”‚ 2. èª¿ç”¨API    â”‚              â”‚ 2. èª¿ç”¨API    â”‚            â”‚
â”‚  â”‚    /api/agent/aâ”‚              â”‚    /api/agent/bâ”‚            â”‚
â”‚  â”‚ 3. ç²å–å°ˆå“¡AID â”‚              â”‚ 3. ç²å–å°ˆå“¡BID â”‚            â”‚
â”‚  â”‚ 4. é€£æ¥WebSocketâ”‚              â”‚ 4. é€£æ¥WebSocketâ”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                    â”‚
                            â”‚ HTTP               â”‚ WebSocket
                            â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¾Œç«¯ (Spring Boot)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ AgentController  â”‚      â”‚ Userhandshakehandlerâ”‚          â”‚
â”‚  â”‚                  â”‚      â”‚                   â”‚            â”‚
â”‚  â”‚ GET /api/agent/a â”‚      â”‚ WebSocketæ¡æ‰‹æ™‚    â”‚            â”‚
â”‚  â”‚ GET /api/agent/b â”‚      â”‚ åˆ¤æ–·å°ˆå“¡é¡å‹       â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ ç²å–/å‰µå»ºå°ˆå“¡ID    â”‚            â”‚
â”‚         â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                           â”‚                      â”‚
â”‚         â–¼                           â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  AgentService     â”‚      â”‚  AgentService     â”‚          â”‚
â”‚  â”‚                   â”‚      â”‚                   â”‚            â”‚
â”‚  â”‚ getAgentAId()     â”‚      â”‚ getOrCreateAgentAId()â”‚        â”‚
â”‚  â”‚ getAgentBId()     â”‚      â”‚ getOrCreateAgentBId()â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                           â”‚                      â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                     â–¼                                      â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚            â”‚  Lua Script      â”‚                            â”‚
â”‚            â”‚  set_agent_id.lua â”‚                            â”‚
â”‚            â”‚  (åŸå­æ€§æ“ä½œ)      â”‚                            â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Redis                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ agent:a:id       â”‚      â”‚ agent:b:id       â”‚          â”‚
â”‚  â”‚ (å°ˆå“¡Açš„ID)       â”‚      â”‚ (å°ˆå“¡Bçš„ID)       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ agent:a:id:info  â”‚      â”‚ agent:b:id:info  â”‚          â”‚
â”‚  â”‚ (å°ˆå“¡Açš„è³‡è¨Š)     â”‚      â”‚ (å°ˆå“¡Bçš„è³‡è¨Š)     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•¸æ“šæµç¨‹

#### 1. å‰ç«¯ç²å–å°ˆå“¡IDæµç¨‹

```
å‰ç«¯é é¢è¼‰å…¥
    â†“
èª¿ç”¨ GET /api/agent/a æˆ– /api/agent/b
    â†“
AgentController è™•ç†è«‹æ±‚
    â†“
AgentService.getAgentAId() æˆ– getAgentBId()
    â†“
å¾ Redis è®€å– agent:a:id æˆ– agent:b:id
    â†“
è¿”å›å°ˆå“¡IDçµ¦å‰ç«¯
    â†“
å‰ç«¯é¡¯ç¤ºå°ˆå“¡IDä¸¦ç”¨æ–¼ç§ä¿¡åŠŸèƒ½
```

#### 2. WebSocketé€£æ¥æµç¨‹

```
å‰ç«¯å»ºç«‹ WebSocket é€£æ¥
    â†“
Userhandshakehandler.determineUser() è¢«èª¿ç”¨
    â†“
æ ¹æ“šè«‹æ±‚URIåˆ¤æ–·å°ˆå“¡é¡å‹ï¼ˆagent-a.html æˆ– agent-b.htmlï¼‰
    â†“
AgentService.getOrCreateAgentAId() æˆ– getOrCreateAgentBId()
    â†“
å¦‚æœRedisä¸­ä¸å­˜åœ¨IDï¼Œç”Ÿæˆæ–°çš„UUID
    â†“
ä½¿ç”¨ Lua è…³æœ¬åŸå­æ€§åœ°è¨­ç½®IDåˆ°Redis
    â†“
è¿”å›å°ˆå“¡IDä½œç‚º Principal
    â†“
WebSocketé€£æ¥å»ºç«‹å®Œæˆ
```

#### 3. IDè¦†è“‹æ©Ÿåˆ¶

```
æ–°çš„WebSocketé€£æ¥å»ºç«‹
    â†“
Userhandshakehandler èª¿ç”¨ getOrCreateAgentXId()
    â†“
å¾Redisç²å–ç¾æœ‰ID
    â†“
å¦‚æœIDä¸åŒï¼Œèª¿ç”¨ Lua è…³æœ¬
    â†“
Luaè…³æœ¬æª¢æŸ¥ï¼š
  - å¦‚æœIDç›¸åŒï¼šåªæ›´æ–°æ™‚é–“æˆ³
  - å¦‚æœIDä¸åŒï¼šè¦†è“‹èˆŠçš„IDï¼ˆå£“æ‰ï¼‰
    â†“
æ–°çš„IDå­˜å„²åˆ°Redis
    â†“
èˆŠçš„é€£æ¥ä»ç„¶å­˜åœ¨ï¼Œä½†IDå·²è¢«è¦†è“‹
```

---

## å¯¦ä½œç´°ç¯€

### 1. Redis Key è¨­è¨ˆ

#### Key å‘½åè¦å‰‡

- **å°ˆå“¡Açš„ID**ï¼š`agent:a:id`
- **å°ˆå“¡Bçš„ID**ï¼š`agent:b:id`
- **å°ˆå“¡Açš„è³‡è¨Š**ï¼š`agent:a:id:info`
- **å°ˆå“¡Bçš„è³‡è¨Š**ï¼š`agent:b:id:info`

#### æ•¸æ“šçµæ§‹

**agent:a:id** (String)
```
å€¼ï¼šå°ˆå“¡Açš„UUIDï¼ˆ32ä½å­—ä¸²ï¼Œç„¡é€£å­—è™Ÿï¼‰
éæœŸæ™‚é–“ï¼š24å°æ™‚
```

**agent:a:id:info** (Hash)
```
id: å°ˆå“¡Açš„UUID
name: "å°ˆå“¡A"
timestamp: æœ€å¾Œæ›´æ–°æ™‚é–“æˆ³ï¼ˆæ¯«ç§’ï¼‰
éæœŸæ™‚é–“ï¼š24å°æ™‚
```

### 2. Lua è…³æœ¬è¨­è¨ˆ

#### è…³æœ¬ä½ç½®

`src/main/resources/lua/set_agent_id.lua`

#### è…³æœ¬åŠŸèƒ½

1. **åŸå­æ€§æª¢æŸ¥**ï¼šæª¢æŸ¥Redisä¸­æ˜¯å¦å·²å­˜åœ¨ID
2. **IDæ¯”è¼ƒ**ï¼šæ¯”è¼ƒæ–°IDå’ŒèˆŠIDæ˜¯å¦ç›¸åŒ
3. **æ¢ä»¶æ›´æ–°**ï¼š
   - å¦‚æœIDç›¸åŒï¼šåªæ›´æ–°æ™‚é–“æˆ³
   - å¦‚æœIDä¸åŒï¼šè¦†è“‹èˆŠçš„ID
4. **éæœŸè¨­ç½®**ï¼šè¨­ç½®24å°æ™‚éæœŸæ™‚é–“

#### è…³æœ¬åƒæ•¸

- `KEYS[1]`ï¼šRedis keyï¼ˆä¾‹å¦‚ `agent:a:id`ï¼‰
- `ARGV[1]`ï¼šæ–°çš„å°ˆå“¡ID
- `ARGV[2]`ï¼šå°ˆå“¡åç¨±ï¼ˆä¾‹å¦‚ `"å°ˆå“¡A"`ï¼‰
- `ARGV[3]`ï¼šç•¶å‰æ™‚é–“æˆ³ï¼ˆæ¯«ç§’ï¼‰

#### è¿”å›å€¼

```lua
-- å¦‚æœå‰µå»ºæ–°çš„ID
{status = 'created', id = newId}

-- å¦‚æœæ›´æ–°ç¾æœ‰IDï¼ˆIDç›¸åŒï¼‰
{status = 'updated', id = newId}

-- å¦‚æœè¦†è“‹èˆŠçš„IDï¼ˆIDä¸åŒï¼‰
{status = 'replaced', oldId = existingId, newId = newId}
```

### 3. AgentService è¨­è¨ˆ

#### ä¸»è¦æ–¹æ³•

1. **getOrCreateAgentAId()**
   - ç²å–å°ˆå“¡Açš„IDï¼Œå¦‚æœä¸å­˜åœ¨å‰‡å‰µå»º
   - ç”¨æ–¼WebSocketæ¡æ‰‹æ™‚

2. **getOrCreateAgentBId()**
   - ç²å–å°ˆå“¡Bçš„IDï¼Œå¦‚æœä¸å­˜åœ¨å‰‡å‰µå»º
   - ç”¨æ–¼WebSocketæ¡æ‰‹æ™‚

3. **getAgentAId()**
   - åƒ…ç²å–å°ˆå“¡Açš„IDï¼Œä¸å‰µå»º
   - ç”¨æ–¼APIæŸ¥è©¢

4. **getAgentBId()**
   - åƒ…ç²å–å°ˆå“¡Bçš„IDï¼Œä¸å‰µå»º
   - ç”¨æ–¼APIæŸ¥è©¢

5. **getAgentId(agentType)**
   - æ ¹æ“šå°ˆå“¡é¡å‹ç²å–ID
   - æ”¯æ´ "a" æˆ– "b"

#### éŒ¯èª¤è™•ç†

- å¦‚æœRedisé€£æ¥å¤±æ•—ï¼Œç”Ÿæˆè‡¨æ™‚IDï¼ˆä¸å­˜å„²åˆ°Redisï¼‰
- è¨˜éŒ„éŒ¯èª¤æ—¥èªŒï¼Œä½†ä¸ä¸­æ–·æµç¨‹

### 4. API è¨­è¨ˆ

#### ç«¯é»åˆ—è¡¨

1. **GET /api/agent/a**
   - ç²å–å°ˆå“¡Açš„ID
   - å›æ‡‰æ ¼å¼ï¼š
     ```json
     {
       "success": true,
       "agentType": "a",
       "agentName": "å°ˆå“¡A",
       "agentId": "abc123..."
     }
     ```

2. **GET /api/agent/b**
   - ç²å–å°ˆå“¡Bçš„ID
   - å›æ‡‰æ ¼å¼ï¼š
     ```json
     {
       "success": true,
       "agentType": "b",
       "agentName": "å°ˆå“¡B",
       "agentId": "def456..."
     }
     ```

3. **GET /api/agent/{agentType}**
   - æ ¹æ“šå°ˆå“¡é¡å‹ç²å–ID
   - æ”¯æ´ "a" æˆ– "b"

---

## ä»£ç¢¼è§£æ

### 1. Lua è…³æœ¬è§£æ

**æ–‡ä»¶ä½ç½®**ï¼š`src/main/resources/lua/set_agent_id.lua`

```lua
-- Lua è…³æœ¬ï¼šåŸå­æ€§åœ°è¨­ç½®å°ˆå“¡ID
-- åƒæ•¸ï¼š
--   KEYS[1]: Redis keyï¼ˆä¾‹å¦‚ "agent:a:id" æˆ– "agent:b:id"ï¼‰
--   ARGV[1]: æ–°çš„å°ˆå“¡ID
--   ARGV[2]: å°ˆå“¡åç¨±ï¼ˆä¾‹å¦‚ "å°ˆå“¡A" æˆ– "å°ˆå“¡B"ï¼‰
--   ARGV[3]: ç•¶å‰æ™‚é–“æˆ³ï¼ˆæ¯«ç§’ï¼‰

-- å¦‚æœkeyå·²å­˜åœ¨ï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºåŒä¸€å€‹ID
local existingId = redis.call('GET', KEYS[1])
local newId = ARGV[1]
local agentName = ARGV[2]
local timestamp = tonumber(ARGV[3])

-- å¦‚æœå·²å­˜åœ¨ä¸”IDä¸åŒï¼Œå‰‡è¦†è“‹ï¼ˆå£“æ‰ï¼‰
-- å¦‚æœå·²å­˜åœ¨ä¸”IDç›¸åŒï¼Œå‰‡æ›´æ–°æ™‚é–“æˆ³
if existingId then
    if existingId ~= newId then
        -- IDä¸åŒï¼Œè¦†è“‹èˆŠçš„ID
        redis.call('SET', KEYS[1], newId)
        redis.call('HSET', KEYS[1] .. ':info', 'id', newId, 'name', agentName, 'timestamp', timestamp)
        redis.call('EXPIRE', KEYS[1], 86400) -- 24å°æ™‚éæœŸ
        redis.call('EXPIRE', KEYS[1] .. ':info', 86400)
        return {status = 'replaced', oldId = existingId, newId = newId}
    else
        -- IDç›¸åŒï¼Œåªæ›´æ–°æ™‚é–“æˆ³
        redis.call('HSET', KEYS[1] .. ':info', 'timestamp', timestamp)
        redis.call('EXPIRE', KEYS[1], 86400)
        redis.call('EXPIRE', KEYS[1] .. ':info', 86400)
        return {status = 'updated', id = newId}
    end
else
    -- ä¸å­˜åœ¨ï¼Œå‰µå»ºæ–°çš„
    redis.call('SET', KEYS[1], newId)
    redis.call('HSET', KEYS[1] .. ':info', 'id', newId, 'name', agentName, 'timestamp', timestamp)
    redis.call('EXPIRE', KEYS[1], 86400)
    redis.call('EXPIRE', KEYS[1] .. ':info', 86400)
    return {status = 'created', id = newId}
end
```

**é—œéµé»è§£æ**ï¼š

1. **åŸå­æ€§ä¿è­‰**ï¼šæ•´å€‹æ“ä½œåœ¨Luaè…³æœ¬ä¸­åŸ·è¡Œï¼Œç¢ºä¿åŸå­æ€§
2. **IDæ¯”è¼ƒ**ï¼šä½¿ç”¨ `existingId ~= newId` æ¯”è¼ƒIDæ˜¯å¦ç›¸åŒ
3. **è¦†è“‹æ©Ÿåˆ¶**ï¼šå¦‚æœIDä¸åŒï¼Œç›´æ¥è¦†è“‹èˆŠçš„ID
4. **éæœŸè¨­ç½®**ï¼šè¨­ç½®24å°æ™‚éæœŸæ™‚é–“ï¼Œé¿å…Redisä¸­ç´¯ç©éå¤šæ•¸æ“š

### 2. AgentService ä»£ç¢¼è§£æ

**æ–‡ä»¶ä½ç½®**ï¼š`src/main/java/com/hejz/springbootstomp/service/AgentService.java`

#### åˆå§‹åŒ–æ–¹æ³•

```java
@PostConstruct
public void init() {
    // è¼‰å…¥Luaè…³æœ¬
    try {
        ClassPathResource resource = new ClassPathResource("lua/set_agent_id.lua");
        String script = new String(resource.getInputStream().readAllBytes(), StandardCharsets.UTF_8);
        setAgentIdScript = new DefaultRedisScript<>();
        setAgentIdScript.setScriptText(script);
        setAgentIdScript.setResultType(Object.class);
        log.info("å°ˆå“¡IDç®¡ç†æœå‹™å·²åˆå§‹åŒ–ï¼ŒLuaè…³æœ¬å·²è¼‰å…¥");
    } catch (IOException e) {
        log.error("ç„¡æ³•è¼‰å…¥ set_agent_id.lua è…³æœ¬: {}", e.getMessage(), e);
        throw new RuntimeException("ç„¡æ³•è¼‰å…¥å°ˆå“¡IDç®¡ç†è…³æœ¬", e);
    }
}
```

**èªªæ˜**ï¼š
- ä½¿ç”¨ `@PostConstruct` ç¢ºä¿åœ¨Beanåˆå§‹åŒ–å¾Œè¼‰å…¥Luaè…³æœ¬
- å¾ `classpath:lua/set_agent_id.lua` è®€å–è…³æœ¬å…§å®¹
- å‰µå»º `DefaultRedisScript` å°è±¡ï¼Œè¨­ç½®è…³æœ¬æ–‡æœ¬å’Œè¿”å›é¡å‹

#### ç²å–æˆ–å‰µå»ºå°ˆå“¡ID

```java
private String getOrCreateAgentId(String agentType, String agentName, String key) {
    try {
        // å…ˆå˜—è©¦ç²å–ç¾æœ‰çš„ID
        String existingId = (String) redisTemplate.opsForValue().get(key);
        
        if (existingId != null && !existingId.isEmpty()) {
            log.info("å¾Redisç²å–{}çš„ID: {}", agentName, existingId);
            // æ›´æ–°æ™‚é–“æˆ³ï¼ˆä½¿ç”¨Luaè…³æœ¬ç¢ºä¿åŸå­æ€§ï¼‰
            updateAgentTimestamp(key, existingId, agentName);
            return existingId;
        }
        
        // å¦‚æœä¸å­˜åœ¨ï¼Œç”Ÿæˆæ–°çš„ID
        String newId = UUID.randomUUID().toString().replaceAll("-", "");
        log.info("ç‚º{}ç”Ÿæˆæ–°ID: {}", agentName, newId);
        
        // ä½¿ç”¨Luaè…³æœ¬åŸå­æ€§åœ°è¨­ç½®ID
        setAgentId(key, newId, agentName);
        
        return newId;
    } catch (Exception e) {
        log.error("ç²å–æˆ–å‰µå»º{}IDæ™‚ç™¼ç”ŸéŒ¯èª¤: {}", agentName, e.getMessage(), e);
        // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œç”Ÿæˆè‡¨æ™‚IDï¼ˆä¸å­˜å„²åˆ°Redisï¼‰
        String tempId = UUID.randomUUID().toString().replaceAll("-", "");
        log.warn("ä½¿ç”¨è‡¨æ™‚ID: {}", tempId);
        return tempId;
    }
}
```

**èªªæ˜**ï¼š
1. **å„ªå…ˆç²å–ç¾æœ‰ID**ï¼šå…ˆå¾Redisè®€å–ï¼Œå¦‚æœå­˜åœ¨å‰‡ç›´æ¥è¿”å›
2. **ç”Ÿæˆæ–°ID**ï¼šå¦‚æœä¸å­˜åœ¨ï¼Œç”Ÿæˆæ–°çš„UUID
3. **åŸå­æ€§è¨­ç½®**ï¼šä½¿ç”¨Luaè…³æœ¬è¨­ç½®IDï¼Œç¢ºä¿åŸå­æ€§
4. **éŒ¯èª¤è™•ç†**ï¼šå¦‚æœRedisé€£æ¥å¤±æ•—ï¼Œç”Ÿæˆè‡¨æ™‚IDï¼Œä¸ä¸­æ–·æµç¨‹

#### è¨­ç½®å°ˆå“¡IDï¼ˆä½¿ç”¨Luaè…³æœ¬ï¼‰

```java
private void setAgentId(String key, String id, String agentName) {
    try {
        long timestamp = System.currentTimeMillis();
        Object result = redisTemplate.execute(setAgentIdScript,
                Collections.singletonList(key),
                id, agentName, String.valueOf(timestamp));
        
        log.info("è¨­ç½®{}IDçµæœ: {}", agentName, result);
    } catch (Exception e) {
        log.error("è¨­ç½®{}IDæ™‚ç™¼ç”ŸéŒ¯èª¤: {}", agentName, e.getMessage(), e);
    }
}
```

**èªªæ˜**ï¼š
- ä½¿ç”¨ `redisTemplate.execute()` åŸ·è¡ŒLuaè…³æœ¬
- å‚³å…¥åƒæ•¸ï¼škeyåˆ—è¡¨ã€æ–°IDã€å°ˆå“¡åç¨±ã€æ™‚é–“æˆ³
- è¨˜éŒ„åŸ·è¡Œçµæœï¼Œä¾¿æ–¼èª¿è©¦

### 3. Userhandshakehandler ä»£ç¢¼è§£æ

**æ–‡ä»¶ä½ç½®**ï¼š`src/main/java/com/hejz/springbootstomp/Userhandshakehandler.java`

#### åˆ¤æ–·å°ˆå“¡é¡å‹

```java
@Override
protected Principal determineUser(ServerHttpRequest request, WebSocketHandler wsHandler, Map<String, Object> attributes){
    String uri = request.getURI().toString();
    String agentId;
    String agentName;
    
    // æ ¹æ“šè«‹æ±‚è·¯å¾‘åˆ¤æ–·æ˜¯å°ˆå“¡Aé‚„æ˜¯å°ˆå“¡B
    if (uri.contains("/agent-a.html") || uri.contains("/agent-a") || 
        attributes.containsKey("agentType") && "a".equals(attributes.get("agentType"))) {
        // å°ˆå“¡A
        agentId = agentService.getOrCreateAgentAId();
        agentName = "å°ˆå“¡A";
    } else if (uri.contains("/agent-b.html") || uri.contains("/agent-b") || 
               attributes.containsKey("agentType") && "b".equals(attributes.get("agentType"))) {
        // å°ˆå“¡B
        agentId = agentService.getOrCreateAgentBId();
        agentName = "å°ˆå“¡B";
    } else {
        // ç„¡æ³•åˆ¤æ–·ï¼Œä½¿ç”¨éš¨æ©ŸIDï¼ˆå‘å¾Œå…¼å®¹ï¼‰
        agentId = UUID.randomUUID().toString().replaceAll("-", "");
        agentName = "æœªçŸ¥ç”¨æˆ¶";
        log.warn("ç„¡æ³•åˆ¤æ–·å°ˆå“¡é¡å‹ï¼Œä½¿ç”¨éš¨æ©ŸID: {}", agentId);
    }
    
    log.info("{} é€£æ¥ï¼ŒID: {}", agentName, agentId);
    
    return new UserPrincipal(agentId);
}
```

**èªªæ˜**ï¼š
1. **URIåˆ¤æ–·**ï¼šå¾è«‹æ±‚URIä¸­åˆ¤æ–·æ˜¯å°ˆå“¡Aé‚„æ˜¯å°ˆå“¡B
2. **ç²å–ID**ï¼šèª¿ç”¨ `AgentService` ç²å–æˆ–å‰µå»ºå°ˆå“¡ID
3. **å‘å¾Œå…¼å®¹**ï¼šå¦‚æœç„¡æ³•åˆ¤æ–·ï¼Œä½¿ç”¨éš¨æ©ŸIDï¼Œç¢ºä¿èˆŠä»£ç¢¼ä»èƒ½é‹è¡Œ

### 4. å‰ç«¯ä»£ç¢¼è§£æ

**æ–‡ä»¶ä½ç½®**ï¼š`src/main/resources/static/agent-a.html`

#### ç²å–å°ˆå“¡ID

```javascript
// å¾APIç²å–å°ˆå“¡Bçš„ID
async function fetchTargetAgentId() {
    try {
        const response = await fetch('/api/agent/b');
        const data = await response.json();
        if (data.success && data.agentId) {
            targetUserId = data.agentId;
            document.getElementById('targetAgentInfo').textContent = 
                `å°ˆå“¡Bçš„ID: ${targetUserId}`;
            console.log('å·²ç²å–å°ˆå“¡Bçš„ID:', targetUserId);
        } else {
            document.getElementById('targetAgentInfo').textContent = 
                'å°ˆå“¡Bå°šæœªé€£æ¥ï¼Œè«‹å…ˆé–‹å•Ÿå°ˆå“¡Bé é¢';
            console.warn('å°ˆå“¡Bå°šæœªé€£æ¥');
        }
    } catch (error) {
        console.error('ç²å–å°ˆå“¡Bçš„IDå¤±æ•—:', error);
        document.getElementById('targetAgentInfo').textContent = 
            'ç„¡æ³•ç²å–å°ˆå“¡Bçš„IDï¼Œè«‹ç¨å¾Œå†è©¦';
    }
}
```

**èªªæ˜**ï¼š
1. **ç•°æ­¥ç²å–**ï¼šä½¿ç”¨ `async/await` ç•°æ­¥ç²å–å°ˆå“¡ID
2. **éŒ¯èª¤è™•ç†**ï¼šä½¿ç”¨ `try/catch` è™•ç†éŒ¯èª¤
3. **UIæ›´æ–°**ï¼šæ›´æ–°é é¢é¡¯ç¤ºå°ˆå“¡ID
4. **å®šæœŸæ›´æ–°**ï¼šé é¢è¼‰å…¥æ™‚èª¿ç”¨ï¼Œä¸¦æ¯5ç§’è‡ªå‹•æ›´æ–°

#### é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–

```javascript
$(document).ready(function() {
    // å…ˆç²å–å°ˆå“¡Bçš„ID
    fetchTargetAgentId();
    // å®šæœŸæ›´æ–°å°ˆå“¡Bçš„IDï¼ˆæ¯5ç§’ï¼‰
    setInterval(fetchTargetAgentId, 5000);
    
    connect();
    // ... å…¶ä»–åˆå§‹åŒ–ä»£ç¢¼
});
```

**èªªæ˜**ï¼š
- é é¢è¼‰å…¥æ™‚ç«‹å³ç²å–å°ˆå“¡ID
- æ¯5ç§’è‡ªå‹•æ›´æ–°ï¼Œç¢ºä¿IDè®ŠåŒ–æ™‚èƒ½åŠæ™‚åæ˜ 

---

## ä½¿ç”¨æ–¹å¼

### 1. å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼

```powershell
# ç¢ºä¿Redisæ­£åœ¨é‹è¡Œï¼ˆWindows PowerShellï¼‰
docker ps | Select-String redis
# æˆ–è€…ä½¿ç”¨éæ¿¾å™¨
docker ps --filter "name=redis"

# å•Ÿå‹•Spring Bootæ‡‰ç”¨ç¨‹å¼
mvn spring-boot:run
```

**æ³¨æ„**ï¼šåœ¨ Windows PowerShell ä¸­ï¼Œ`grep` ä¸æ˜¯åŸç”Ÿå‘½ä»¤ï¼Œæ‡‰è©²ä½¿ç”¨ `Select-String` æˆ– Docker çš„ `--filter` é¸é …ã€‚

### 2. è¨ªå•å‰ç«¯é é¢

1. **æ‰“é–‹å°ˆå“¡Aé é¢**ï¼š
   ```
   http://localhost:8080/agent-a.html
   ```

2. **æ‰“é–‹å°ˆå“¡Bé é¢**ï¼š
   ```
   http://localhost:8080/agent-b.html
   ```

### 3. è§€å¯Ÿå°ˆå“¡ID

- å°ˆå“¡Aé é¢æœƒè‡ªå‹•é¡¯ç¤ºã€Œå°ˆå“¡Bçš„ID: xxxã€
- å°ˆå“¡Bé é¢æœƒè‡ªå‹•é¡¯ç¤ºã€Œå°ˆå“¡Açš„ID: xxxã€
- ç„¡éœ€æ‰‹å‹•è¼¸å…¥ï¼Œç³»çµ±è‡ªå‹•ç²å–

### 4. æ¸¬è©¦ç§ä¿¡åŠŸèƒ½

1. åœ¨å°ˆå“¡Aé é¢è¼¸å…¥ç§ä¿¡å…§å®¹
2. é»æ“Šã€Œç™¼é€ç§ä¿¡ã€æŒ‰éˆ•
3. å°ˆå“¡Bé é¢æ‡‰è©²æ”¶åˆ°ç§ä¿¡
4. åä¹‹äº¦ç„¶

### 5. æ¸¬è©¦IDè¦†è“‹æ©Ÿåˆ¶

1. æ‰“é–‹å°ˆå“¡Aé é¢ï¼ˆç¬¬ä¸€å€‹çª—å£ï¼‰
2. å†æ‰“é–‹å°ˆå“¡Aé é¢ï¼ˆç¬¬äºŒå€‹çª—å£ï¼‰
3. è§€å¯ŸRedisä¸­çš„IDæ˜¯å¦è¢«è¦†è“‹
4. åªæœ‰æœ€æ–°çš„é€£æ¥æœƒä½¿ç”¨æ–°çš„ID

---

## æ¸¬è©¦æ–¹æ³•

### 1. å–®å…ƒæ¸¬è©¦

#### æ¸¬è©¦AgentService

```java
@Test
void testGetOrCreateAgentAId() {
    // ç¬¬ä¸€æ¬¡èª¿ç”¨æ‡‰è©²å‰µå»ºæ–°çš„ID
    String id1 = agentService.getOrCreateAgentAId();
    assertNotNull(id1);
    
    // ç¬¬äºŒæ¬¡èª¿ç”¨æ‡‰è©²è¿”å›ç›¸åŒçš„ID
    String id2 = agentService.getOrCreateAgentAId();
    assertEquals(id1, id2);
}
```

#### æ¸¬è©¦AgentController

```java
@Test
void testGetAgentA() {
    ResponseEntity<Map<String, Object>> response = agentController.getAgentA();
    assertEquals(200, response.getStatusCodeValue());
    assertTrue((Boolean) response.getBody().get("success"));
}
```

### 2. é›†æˆæ¸¬è©¦

#### æ¸¬è©¦APIç«¯é»

**Windows PowerShellï¼š**
```powershell
# æ¸¬è©¦ç²å–å°ˆå“¡Açš„ID
Invoke-WebRequest -Uri "http://localhost:8080/api/agent/a" | Select-Object -ExpandProperty Content

# æ¸¬è©¦ç²å–å°ˆå“¡Bçš„ID
Invoke-WebRequest -Uri "http://localhost:8080/api/agent/b" | Select-Object -ExpandProperty Content
```

**Linux/Macï¼ˆæˆ–ä½¿ç”¨ curlï¼‰ï¼š**
```bash
# æ¸¬è©¦ç²å–å°ˆå“¡Açš„ID
curl http://localhost:8080/api/agent/a

# æ¸¬è©¦ç²å–å°ˆå“¡Bçš„ID
curl http://localhost:8080/api/agent/b
```

#### æ¸¬è©¦Rediså­˜å„²

```bash
# æª¢æŸ¥å°ˆå“¡Açš„ID
docker exec redis redis-cli GET "agent:a:id"

# æª¢æŸ¥å°ˆå“¡Açš„è³‡è¨Š
docker exec redis redis-cli HGETALL "agent:a:id:info"

# æª¢æŸ¥å°ˆå“¡Bçš„ID
docker exec redis redis-cli GET "agent:b:id"
```

### 3. æ‰‹å‹•æ¸¬è©¦

#### æ¸¬è©¦å ´æ™¯1ï¼šæ­£å¸¸æµç¨‹

1. æ‰“é–‹å°ˆå“¡Aé é¢
2. è§€å¯Ÿæ˜¯å¦è‡ªå‹•ç²å–å°ˆå“¡Bçš„ID
3. ç™¼é€ç§ä¿¡çµ¦å°ˆå“¡B
4. ç¢ºèªå°ˆå“¡Bæ”¶åˆ°ç§ä¿¡

#### æ¸¬è©¦å ´æ™¯2ï¼šIDè¦†è“‹

1. æ‰“é–‹å°ˆå“¡Aé é¢ï¼ˆçª—å£1ï¼‰
2. è¨˜éŒ„å°ˆå“¡Açš„ID
3. é—œé–‰çª—å£1
4. æ‰“é–‹å°ˆå“¡Aé é¢ï¼ˆçª—å£2ï¼‰
5. è§€å¯Ÿå°ˆå“¡Açš„IDæ˜¯å¦æ”¹è®Š
6. ç¢ºèªèˆŠçš„IDå·²è¢«è¦†è“‹

#### æ¸¬è©¦å ´æ™¯3ï¼šå¤šé‡é€£æ¥

1. æ‰“é–‹å°ˆå“¡Aé é¢ï¼ˆçª—å£1ï¼‰
2. æ‰“é–‹å°ˆå“¡Aé é¢ï¼ˆçª—å£2ï¼‰
3. è§€å¯ŸRedisä¸­çš„ID
4. ç¢ºèªåªæœ‰æœ€æ–°çš„IDè¢«å­˜å„²

---

## å¸¸è¦‹å•é¡Œ

### Q1: ç‚ºä»€éº¼è¦ä½¿ç”¨Luaè…³æœ¬ï¼Ÿ

**A**: Luaè…³æœ¬å¯ä»¥ç¢ºä¿Redisæ“ä½œçš„åŸå­æ€§ã€‚åœ¨å¤šç·šç¨‹æˆ–å¤šé€²ç¨‹ç’°å¢ƒä¸‹ï¼Œå¦‚æœæ²’æœ‰åŸå­æ€§ä¿è­‰ï¼Œå¯èƒ½æœƒå‡ºç¾ä»¥ä¸‹å•é¡Œï¼š

1. **ç«¶æ…‹æ¢ä»¶**ï¼šå…©å€‹ç·šç¨‹åŒæ™‚è®€å–å’Œå¯«å…¥ï¼Œå°è‡´æ•¸æ“šä¸ä¸€è‡´
2. **è¦†è“‹å•é¡Œ**ï¼šæ–°çš„IDå¯èƒ½è¢«èˆŠçš„IDè¦†è“‹
3. **æ™‚é–“æˆ³ä¸åŒæ­¥**ï¼šIDå’Œæ™‚é–“æˆ³å¯èƒ½ä¸ä¸€è‡´

ä½¿ç”¨Luaè…³æœ¬å¯ä»¥ç¢ºä¿æ•´å€‹æ“ä½œåœ¨Redisæœå‹™å™¨ç«¯åŸå­æ€§åŸ·è¡Œã€‚

### Q2: ç‚ºä»€éº¼è¦è¨­ç½®24å°æ™‚éæœŸæ™‚é–“ï¼Ÿ

**A**: è¨­ç½®éæœŸæ™‚é–“å¯ä»¥ï¼š

1. **è‡ªå‹•æ¸…ç†**ï¼šå¦‚æœå°ˆå“¡é•·æ™‚é–“ä¸é€£æ¥ï¼Œè‡ªå‹•æ¸…ç†éæœŸæ•¸æ“š
2. **ç¯€çœå…§å­˜**ï¼šé¿å…Redisä¸­ç´¯ç©éå¤šç„¡ç”¨æ•¸æ“š
3. **é‡æ–°åˆå§‹åŒ–**ï¼šéæœŸå¾Œå¯ä»¥é‡æ–°ç”Ÿæˆæ–°çš„ID

å¦‚æœéœ€è¦æ°¸ä¹…å­˜å„²ï¼Œå¯ä»¥ç§»é™¤ `EXPIRE` å‘½ä»¤ã€‚

### Q3: å¦‚æœRedisé€£æ¥å¤±æ•—æ€éº¼è¾¦ï¼Ÿ

**A**: ç³»çµ±è¨­è¨ˆäº†å®¹éŒ¯æ©Ÿåˆ¶ï¼š

1. **è‡¨æ™‚ID**ï¼šå¦‚æœRedisé€£æ¥å¤±æ•—ï¼Œç”Ÿæˆè‡¨æ™‚IDï¼ˆä¸å­˜å„²åˆ°Redisï¼‰
2. **éŒ¯èª¤æ—¥èªŒ**ï¼šè¨˜éŒ„éŒ¯èª¤æ—¥èªŒï¼Œä¾¿æ–¼æ’æŸ¥å•é¡Œ
3. **ä¸ä¸­æ–·æµç¨‹**ï¼šå³ä½¿Rediså¤±æ•—ï¼ŒWebSocketé€£æ¥ä»èƒ½å»ºç«‹

### Q4: å¦‚ä½•åˆ¤æ–·å°ˆå“¡é¡å‹ï¼Ÿ

**A**: ç›®å‰æœ‰å…©ç¨®åˆ¤æ–·æ–¹å¼ï¼š

1. **URIåˆ¤æ–·**ï¼šå¾è«‹æ±‚URIä¸­åˆ¤æ–·ï¼ˆ`/agent-a.html` æˆ– `/agent-b.html`ï¼‰
2. **å±¬æ€§åˆ¤æ–·**ï¼šå¾WebSocket attributesä¸­åˆ¤æ–·ï¼ˆå¦‚æœé å…ˆè¨­ç½®ï¼‰

å¦‚æœå…©ç¨®æ–¹å¼éƒ½ç„¡æ³•åˆ¤æ–·ï¼Œç³»çµ±æœƒä½¿ç”¨éš¨æ©ŸIDï¼ˆå‘å¾Œå…¼å®¹ï¼‰ã€‚

### Q5: å‰ç«¯å¦‚ä½•çŸ¥é“å°ˆå“¡IDè®ŠåŒ–ï¼Ÿ

**A**: å‰ç«¯ä½¿ç”¨å…©ç¨®æ©Ÿåˆ¶ï¼š

1. **å®šæœŸè¼ªè©¢**ï¼šæ¯5ç§’è‡ªå‹•èª¿ç”¨APIç²å–æœ€æ–°çš„å°ˆå“¡ID
2. **é€£æ¥æ™‚ç²å–**ï¼šWebSocketé€£æ¥æ™‚å¾æœå‹™å™¨ç²å–å°ˆå“¡ID

å¦‚æœå°ˆå“¡IDæ”¹è®Šï¼Œå‰ç«¯æœƒåœ¨5ç§’å…§è‡ªå‹•æ›´æ–°ã€‚

### Q6: å¦‚ä½•é˜²æ­¢åŒä¸€å€‹å°ˆå“¡é–‹å¤šå€‹ç¶²é ï¼Ÿ

**A**: ç³»çµ±é€šéä»¥ä¸‹æ©Ÿåˆ¶é˜²æ­¢ï¼š

1. **å›ºå®šIDå­˜å„²**ï¼šå°ˆå“¡Aå’Œå°ˆå“¡Bå„è‡ªåªæœ‰ä¸€å€‹IDå­˜å„²åœ¨Redisä¸­
2. **IDè¦†è“‹**ï¼šå¦‚æœåŒä¸€å€‹å°ˆå“¡é–‹å¤šå€‹ç¶²é ï¼Œå¾Œé¢çš„é€£æ¥æœƒè¦†è“‹å‰é¢çš„ID
3. **æœ€æ–°é€£æ¥æœ‰æ•ˆ**ï¼šåªæœ‰æœ€æ–°çš„é€£æ¥æœƒè¢«è¦–ç‚ºæœ‰æ•ˆé€£æ¥

ä½†æ˜¯ï¼Œ**èˆŠçš„é€£æ¥ä»ç„¶å­˜åœ¨**ï¼Œåªæ˜¯IDå·²è¢«è¦†è“‹ã€‚å¦‚æœéœ€è¦å®Œå…¨æ–·é–‹èˆŠé€£æ¥ï¼Œéœ€è¦é¡å¤–çš„æ©Ÿåˆ¶ï¼ˆä¾‹å¦‚å¿ƒè·³æª¢æ¸¬ï¼‰ã€‚

### Q7: å¦‚ä½•æ“´å±•æ”¯æ´æ›´å¤šå°ˆå“¡ï¼Ÿ

**A**: å¯ä»¥é€šéä»¥ä¸‹æ–¹å¼æ“´å±•ï¼š

1. **å‹•æ…‹å°ˆå“¡é¡å‹**ï¼šä¿®æ”¹ `AgentService` æ”¯æ´å‹•æ…‹å°ˆå“¡é¡å‹
2. **é…ç½®åŒ–**ï¼šå°‡å°ˆå“¡åˆ—è¡¨é…ç½®åˆ° `application.properties`
3. **æ•¸æ“šåº«å­˜å„²**ï¼šå¦‚æœéœ€è¦æŒä¹…åŒ–ï¼Œå¯ä»¥å­˜å„²åˆ°æ•¸æ“šåº«

ç›®å‰ç³»çµ±è¨­è¨ˆç‚ºå›ºå®šå…©å€‹å°ˆå“¡ï¼ˆå°ˆå“¡Aå’Œå°ˆå“¡Bï¼‰ï¼Œæ“´å±•éœ€è¦ä¿®æ”¹ä»£ç¢¼ã€‚

---

## ç¸½çµ

å°ˆå“¡IDç®¡ç†ç³»çµ±é€šéä»¥ä¸‹æ–¹å¼è§£æ±ºäº†åŸå§‹å•é¡Œï¼š

1. âœ… **å›ºå®šID**ï¼šå°ˆå“¡Aå’Œå°ˆå“¡Bå„è‡ªæœ‰å›ºå®šçš„ID
2. âœ… **è‡ªå‹•ç²å–**ï¼šå‰ç«¯è‡ªå‹•å¾APIç²å–å°ˆå“¡ID
3. âœ… **åŸå­æ€§ä¿è­‰**ï¼šä½¿ç”¨Luaè…³æœ¬ç¢ºä¿æ“ä½œçš„åŸå­æ€§
4. âœ… **è‡ªå‹•è¦†è“‹**ï¼šå¦‚æœIDæ”¹è®Šï¼Œè‡ªå‹•è¦†è“‹èˆŠçš„ID
5. âœ… **å³æ™‚æ›´æ–°**ï¼šå‰ç«¯æ¯5ç§’è‡ªå‹•æ›´æ–°å°ˆå“¡ID

ç³»çµ±è¨­è¨ˆç°¡æ½”ã€å¯é ï¼Œæ˜“æ–¼ç¶­è­·å’Œæ“´å±•ã€‚

---

## åƒè€ƒè³‡æ–™

- [Redis Luaè…³æœ¬æ–‡æª”](https://redis.io/commands/eval/)
- [Spring WebSocketæ–‡æª”](https://docs.spring.io/spring-framework/reference/web/websocket.html)
- [Spring Data Redisæ–‡æª”](https://docs.spring.io/spring-data/redis/docs/current/reference/html/)

---

**æ–‡æª”ç‰ˆæœ¬**ï¼š1.0  
**æœ€å¾Œæ›´æ–°**ï¼š2025-12-19  
**ä½œè€…**ï¼šSpring Boot STOMP WebSocket Team

